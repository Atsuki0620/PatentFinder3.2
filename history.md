# PatentFinder 開発経緯サマリー（詳細版）

## 1. PatentFinder v2.2：GUIによる対話型検索の試み

### 1.1. 目的とアーキテクチャ
- **目的**: Streamlitを利用し、専門家でなくても直感的に操作できる対話型の特許調査GUIアプリケーションを構築する。
- **アーキテクチャ**:
  - **UI (`app.py`)**: Streamlitを採用。サイドバーでのAPIキー設定、メイン画面でのAIとのチャット、生成された検索条件の確認・編集、検索結果の表示・要約といった一連の操作をWebブラウザ上で完結させる設計。
  - **バックエンド**: Pythonをベースに、OpenAI APIによる自然言語解釈と検索条件提案、Google BigQueryによる特許検索を実行。
  - **検索ロジック**: ユーザーとの対話から生成したキーワードとIPC分類を元に、固定的なSQLクエリを生成。さらに、検索結果に対して調査方針とのベクトル類似度（コサイン類似度）を計算し、ランキング表示する高度な機能も実装していた。

### 1.2. 課題：検索能力の限界
- **硬直的な検索ロジック**: v2.2は対話形式で検索の入り口をサポートする一方、生成されるSQLクエリのロジックが固定的であった。これにより、ユーザーの nuanced な要求（例：「この技術分野は必須だが、こちらの要素はあれば尚良い」といった条件）を反映できず、検索結果の精度が安定しなかった。
- **精度と網羅性のジレンマ**: 生成される検索条件では、「検索漏れ」と「ノイズ」のバランスをユーザーが柔軟に調整することが困難であり、根本的な検索能力の強化が求められた。

---

## 2. PatentFinder v3.1：CLIによる検索力強化へのピボット

### 2.1. 方針転換：UIからコアロジックへ
- **背景**: v2.2の課題を受け、`AI特許調査プログラム開発プラン_revised.md`で明確に方針を転換。「初期開発フェーズではUI（Streamlit）の実装は行わず、まず**Pythonスクリプト**として、プログラムの核となる**対話型の検索ロジック生成機能**の確立に注力します」と定義された。
- **目的**: AIとの対話を通じて、多様かつ高精度なBigQueryのSQLクエリを動的に生成し、その有効性を体系的に検証するパイプラインを構築する。
- **開発スタイル**:
  - **対話型スクリプト (`patent_search_script.py`)**: ユーザーとの対話を通じてキーワードやIPC分類を決定するコア機能を実装。
  - **テストランナー (`batch_test_runner_v3.py`, `final_report_runner_v5_refined.py`)**: 様々な検索戦略をコード化し、自動で実行・評価するスクリプトを作成。
  - **結果の記録 (`investigations/`フォルダ)**: 各テストの結果とLLMによる評価を詳細なレポートとして保存し、試行錯誤の過程をナレッジとして蓄積。

### 2.2. 検索戦略の試行錯誤の歴史

`investigations/`フォルダ内の多数のレポートは、最適な検索ロジックを模索した過程を詳細に記録している。

#### フェーズ1：単純な論理演算によるアプローチ (2025/07/21頃)
- **戦略**: AIが提案したキーワード群とIPC分類群を、単純な論理演算子（`AND`/`OR`）で組み合わせる。
- **試行A（高精度狙い）**: `(IPC OR ...) AND (キーワードグループ1 OR...) AND (キーワードグループ2 OR...)` という厳格な`AND`条件で検索。
  - **結果**: ヒット件数 **0件**。条件が厳しすぎ、関連特許をすべて弾いてしまった (`inv_20250721_235403/summary_report.txt`)。
- **試行B（網羅性狙い）**: `(IPC OR ...) OR (キーワード OR ...)` という緩い`OR`条件で検索。
  - **結果**: 多数ヒットするものの、LLMの評価は「調査テーマに完全にマッチした特許を抽出できていません」となり、無関係なノイズが大量に含まれていた。
- **結論**: **「絞ると見つからない、広げるとノイズまみれ」**という典型的なジレンマに直面。単純な論理演算では不十分であることが明らかになった。

#### フェーズ2：検索条件の緩和による網羅性向上 (2025/07/22未明)
- **戦略**: `batch_test_runner_v3.py`を開発し、検索条件を体系的に「緩和」するアプローチを自動テスト。
  - **テストA (キーワード拡張)**: IPCは固定し、AIに生成させた類義語・関連語を加えてキーワードの範囲を広げる。
  - **テストB (IPC緩和)**: キーワードは固定し、IPC分類を上位階層に緩和（例：`G05B13/02` → `G05B`）して技術分野の裾野を広げる。
  - **テストC (両方緩和)**: 最も広範なサーベイ調査。
- **SQLロジック**: いずれのテストも、最終的な結合は `WHERE (IPC OR ...) OR (Keyword OR ...)` という単純な`OR`結合がベース。
- **結果**: いずれのアプローチもヒット件数は50件に達したが、LLMによる評価は「調査の意図にマッチした特許を抽出することはできませんでした」と芳しくなく、**精度の低い結果**しか得られなかった (`inv_20250722_001900`, `inv_20250722_003952`など)。

#### フェーズ3：「主語」と「述語」による高度な検索戦略 (2025/07/22)
- **着想**: `docs/session_summaries/...`に記録されているように、「技術の主語になるものは階層的分類は具体化するのが良い」という専門的な特許調査の考え方を導入。
- **戦略**: `final_report_runner_v5_refined.py`で実装。
  - **主語（必須条件）**: 技術の核となる「逆浸透膜」関連のIPC分類 (`B01D61/02`, `C02F1/44`) は**必須**とする。
  - **述語（緩和条件）**: それをどうする技術か、という「制御システム」関連の緩和IPC (`G05B`) や、関連キーワード群は**いずれか一つに合致すればよい**とする。
- **SQLロジック**: `WHERE (subject_IPC_A OR subject_IPC_B) AND (predicate_IPC OR keyword_A OR keyword_B ...)`
- **結果**: この戦略により、初めて調査の軸が明確になり、関連性の高い特許が多数ヒット。LLM評価も「以前の検索と比較して有効だった」と一定の評価を得た。しかし、「惜しい」特許は含まれるものの、まだ**調査意図に100%合致する「ど真ん中」の特許**を見つけ出すには至っていない (`inv_20250722_005103/summary_report_v5_refined.txt`)。

### 2.3. 現在のステータスと今後の展望
- **完了したこと**:
  - AIとの対話からBigQuery検索、レポート生成までの一連のパイプラインはCLI上で完成。
  - BigQuery接続における認証エラー (`403 Permission Denied`) をサービスアカウントキーの明示的な指定で解決するなど、技術的な知見を蓄積。
  - 様々な検索戦略を試し、その長所と短所をデータとして記録。
- **現在の課題**:
  - 最適な検索論理（WHERE句の構造）と、検索ターム（キーワード、IPC）の組み合わせが未だ特定できていない。
  - そもそも選定しているキーワードやIPCが、**実際の特許公報で使われている表現と乖離している可能性**が最大の懸念点となっている。
- **今後の展望（ネクストステップ）**:
  - これ以上やみくもに検索を繰り返すのではなく、より分析的なアプローチへ移行する。
  - **提案：「検索結果のメタ分析」**:
    1. これまでの調査で見つかった「惜しい」特許（例: `US-9360848-B2`, `US-10597308-B2`）の要約をAIにインプットとして与える。
    2. それらを分析させ、「本当に探している特許は、どのような**別の専門用語（具体的なアルゴリズム名など）や、ニッチなIPC分類**で表現されている可能性があるか？」を**逆推論**させる。
    3. AIが提案した新しい検索タームと、場合によっては新しい検索ロジックで、`v6_meta.py`のような新しいテストスクリプトを実行する。

この「メタ分析」アプローチにより、これまでの失敗から学び、より成功確率の高い、洗練された次の調査フェーズに進むことが期待される。