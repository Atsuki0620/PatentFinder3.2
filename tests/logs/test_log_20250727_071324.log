2025-07-27 07:13:24,477 [INFO] ログファイルを次の場所に作成しました: C:\Users\atsuk\OneDrive\ドキュメント\GeminiCLI\2507 PatesntFinder3.2\standalone_tests\logs\test_log_20250727_071324.log
2025-07-27 07:13:24,478 [INFO] --- テスト開始 ---
2025-07-27 07:13:24,478 [INFO] 使用する検索条件:
SearchConditions(subject_keywords=['semiconductor', 'manufacturing'], subject_ipc=['H01L'], predicate_keywords=['defect', 'inspection'], predicate_ipc=[], start_date=None, end_date=None, countries=['US'], limit=15)
2025-07-27 07:13:24,478 [INFO] --- 生成されたSQL ---
2025-07-27 07:13:24,491 [INFO] WITH PatentData AS (
            SELECT
                publication_number,
                (SELECT text FROM UNNEST(title_localized) WHERE language IN ('en', 'ja') LIMIT 1) as title,
                (SELECT text FROM UNNEST(abstract_localized) WHERE language IN ('en', 'ja') LIMIT 1) as abstract,
                (SELECT STRING_AGG(name) FROM UNNEST(assignee_harmonized)) as assignee,
                publication_date,
                ipc, -- IPCをそのまま渡す
                (SELECT STRING_AGG(code) FROM UNNEST(ipc)) as ipc_codes,
                CONCAT(
                    (SELECT text FROM UNNEST(title_localized) WHERE language IN ('en', 'ja') LIMIT 1), ' ',
                    (SELECT text FROM UNNEST(abstract_localized) WHERE language IN ('en', 'ja') LIMIT 1)
                ) as search_text
            FROM
                `patents-public-data.patents.publications`
        )
        SELECT
            p.publication_number,
            p.title,
            p.abstract,
            p.assignee,
            p.publication_date,
            p.ipc_codes
        FROM
            PatentData p
        WHERE
  SUBSTR(p.publication_number, 1, 2) IN UNNEST(@countries)
  AND ((LOWER(p.search_text) LIKE @s_kw_0 OR LOWER(p.search_text) LIKE @s_kw_1) AND (EXISTS (SELECT 1 FROM UNNEST(p.ipc) AS ipc WHERE ipc.code LIKE @s_ipc_2)))
  AND ((LOWER(p.search_text) LIKE @p_kw_3 OR LOWER(p.search_text) LIKE @p_kw_4))
        LIMIT @limit
2025-07-27 07:13:24,491 [INFO] --- SQLパラメータ ---
2025-07-27 07:13:24,491 [INFO] {
  "countries": {
    "type": "ARRAY<STRING>",
    "value": [
      "US"
    ]
  },
  "s_kw_0": {
    "type": "STRING",
    "value": "%semiconductor%"
  },
  "s_kw_1": {
    "type": "STRING",
    "value": "%manufacturing%"
  },
  "s_ipc_2": {
    "type": "STRING",
    "value": "H01L%"
  },
  "p_kw_3": {
    "type": "STRING",
    "value": "%defect%"
  },
  "p_kw_4": {
    "type": "STRING",
    "value": "%inspection%"
  },
  "limit": {
    "type": "INT64",
    "value": 15
  }
}
2025-07-27 07:13:24,491 [INFO] --- BigQuery検索開始 ---
2025-07-27 07:13:25,739 [ERROR] BigQueryの検索中にエラーが発生しました.
Traceback (most recent call last):
  File "C:\Users\atsuk\OneDrive\ドキュメント\GeminiCLI\2507 PatesntFinder3.2\src\core\bq_client.py", line 43, in execute_query
    query_job = client.query(sql, job_config=job_config)
  File "C:\Users\atsuk\AppData\Roaming\Python\Python313\site-packages\google\cloud\bigquery\client.py", line 3519, in query
    return _job_helpers.query_jobs_insert(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self,
        ^^^^^
    ...<8 lines>...
        job_retry,
        ^^^^^^^^^^
    )
    ^
  File "C:\Users\atsuk\AppData\Roaming\Python\Python313\site-packages\google\cloud\bigquery\_job_helpers.py", line 182, in query_jobs_insert
    future = do_query()
  File "C:\Users\atsuk\AppData\Roaming\Python\Python313\site-packages\google\api_core\retry\retry_unary.py", line 294, in retry_wrapped_func
    return retry_target(
        target,
    ...<3 lines>...
        on_error=on_error,
    )
  File "C:\Users\atsuk\AppData\Roaming\Python\Python313\site-packages\google\api_core\retry\retry_unary.py", line 156, in retry_target
    next_sleep = _retry_error_helper(
        exc,
    ...<6 lines>...
        timeout,
    )
  File "C:\Users\atsuk\AppData\Roaming\Python\Python313\site-packages\google\api_core\retry\retry_base.py", line 214, in _retry_error_helper
    raise final_exc from source_exc
  File "C:\Users\atsuk\AppData\Roaming\Python\Python313\site-packages\google\api_core\retry\retry_unary.py", line 147, in retry_target
    result = target()
  File "C:\Users\atsuk\AppData\Roaming\Python\Python313\site-packages\google\cloud\bigquery\_job_helpers.py", line 138, in do_query
    query_job._begin(retry=retry, timeout=timeout)
    ~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\atsuk\AppData\Roaming\Python\Python313\site-packages\google\cloud\bigquery\job\query.py", line 1398, in _begin
    super(QueryJob, self)._begin(client=client, retry=retry, timeout=timeout)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\atsuk\AppData\Roaming\Python\Python313\site-packages\google\cloud\bigquery\job\base.py", line 780, in _begin
    api_response = client._call_api(
        retry,
    ...<6 lines>...
        timeout=timeout,
    )
  File "C:\Users\atsuk\AppData\Roaming\Python\Python313\site-packages\google\cloud\bigquery\client.py", line 858, in _call_api
    return call()
  File "C:\Users\atsuk\AppData\Roaming\Python\Python313\site-packages\google\api_core\retry\retry_unary.py", line 294, in retry_wrapped_func
    return retry_target(
        target,
    ...<3 lines>...
        on_error=on_error,
    )
  File "C:\Users\atsuk\AppData\Roaming\Python\Python313\site-packages\google\api_core\retry\retry_unary.py", line 156, in retry_target
    next_sleep = _retry_error_helper(
        exc,
    ...<6 lines>...
        timeout,
    )
  File "C:\Users\atsuk\AppData\Roaming\Python\Python313\site-packages\google\api_core\retry\retry_base.py", line 214, in _retry_error_helper
    raise final_exc from source_exc
  File "C:\Users\atsuk\AppData\Roaming\Python\Python313\site-packages\google\api_core\retry\retry_unary.py", line 147, in retry_target
    result = target()
  File "C:\Users\atsuk\AppData\Roaming\Python\Python313\site-packages\google\cloud\_http\__init__.py", line 494, in api_request
    raise exceptions.from_http_response(response)
google.api_core.exceptions.BadRequest: 400 POST https://bigquery.googleapis.com/bigquery/v2/projects/corded-guild-459506-i6/jobs?prettyPrint=false: Invalid value for type: ARRAY<STRING> is not a valid value

Location: None
Job ID: 291aa6d2-7bb8-4b28-8980-98f62fdc52c0


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\atsuk\OneDrive\ドキュメント\GeminiCLI\2507 PatesntFinder3.2\standalone_tests\test_runner.py", line 109, in main
    results_df = bq_client.execute_query(sql, params, credentials_info=gcp_credentials)
  File "C:\Users\atsuk\OneDrive\ドキュメント\GeminiCLI\2507 PatesntFinder3.2\src\core\bq_client.py", line 49, in execute_query
    raise BQClientError(f"BigQueryのクエリエラーが発生しました。SQLの構文を確認してください。\n--- Details---\n{error_details}") from e
src.core.bq_client.BQClientError: BigQueryのクエリエラーが発生しました。SQLの構文を確認してください。
--- Details---
Invalid value for type: ARRAY<STRING> is not a valid value
2025-07-27 07:13:25,815 [INFO] --- テスト終了 ---
