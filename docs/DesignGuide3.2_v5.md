# PatentFinder 3.2 設計・実装ガイド (v5)

## 1. 設計原則

-   **UIとロジックの完全な分離**: StreamlitのUIコード (`src/ui/`) は、表示とユーザー入力の受付に専念する。コアなビジネスロジック (`src/core/`) はUIフレームワークから完全に独立し、テスト可能でなければならない。
-   **テスト可能性 (Testability)**: すべてのコアロジックは、UIを介さずに直接呼び出し、テストできる設計でなければならない。依存性注入（例: `bq_client`への認証情報注入）を積極的に活用する。
-   **拡張性 (Extensibility)**: 新しい機能（特に検索戦略）を追加する際に、既存のコードへの変更が最小限で済むように、ストラテジーパターンなどのデザインパターンを活用する。

## 2. アーキテクチャ

### 2.1. システム構成図とデータフロー
```mermaid
graph TD
    subgraph "User Interface (Streamlit)"
        A[ui/main_view.py] -- "1. ユーザー操作" --> B(core/agent.py);
        A -- "結果を元に描画" --> G(core/visualize.py);
        A -- "レポート生成依頼" --> H(core/reporter.py);
    end

    subgraph "Core Logic (src/core)"
        B -- "2. SQL生成依頼" --> C(strategies/default.py);
        C -- "3. SQLとパラメータを返却" --> B;
        B -- "4. 検索実行依頼" --> D(bq_client.py);
        D -- "7. 結果(DataFrame) or BQClientError" --> B;
        B -- "8. AppState更新" --> F(core/state.py);
        A -- "9. AppStateを監視しUI再描画" --> A;
    end

    subgraph "External Services"
        D -- "5. パラメータ化クエリ実行" --> E[("Google BigQuery")];
        E -- "6. 検索結果" --> D;
        H -- "LLMに要約依頼" --> I[("OpenAI API")];
        I -- "生成されたレポート" --> H;
    end

    style A fill:#cde4ff
    style F fill:#ffe8cd
```

## 3. コンポーネント実装ガイド

-   **`src/core/state.py`**:
    -   **責務**: Streamlitの`st.session_state`に格納される、アプリケーション全体の状態を定義するデータクラス。
    -   **設計意図**: アプリケーションの状態を一元管理する「Single Source of Truth」としての役割を担う。これにより、状態の参照と更新が予測可能になり、コードの見通しが良くなる。

-   **`src/core/agent.py`**:
    -   **責務**: UIからのリクエストを受け取り、LLMとの対話、検索戦略の選択、`bq_client`の呼び出し、結果の加工といった一連のワークフローを統括するオーケストレーター。
    -   **設計意図**: UIとコアロジック（SQL生成、DB接続など）の間に立つ「エージェント」として機能する。UIは「何をしたいか」をエージェントに伝えるだけでよく、具体的な実現方法を知る必要がない。

-   **`src/core/bq_client.py`**:
    -   **責務**: BigQueryへの接続、安全なパラメータ化クエリの実行、結果の取得、そしてエラーハンドリングに特化したクライアント。
    -   **設計意図**: 認証情報を引数として外部から注入できる（依存性注入）設計になっている。これにより、Streamlitのセッション情報に依存せず、テストスクリプトのような外部のプログラムからも容易に再利用できる。エラー発生時には、詳細情報を含むカスタム例外`BQClientError`を送出する。

-   **`src/core/strategies/`**:
    -   **責務**: SQLクエリを生成する具体的なロジックを格納する。
    -   **設計意図**: ストラテジーパターンを採用。すべての戦略は`base.py`の共通インターフェースを実装する。これにより、`agent.py`は具体的なSQL生成ロジックを知ることなく、戦略を動的に切り替えることが可能になる。将来、「類似特許検索戦略」などを追加する際は、このディレクトリに新しいファイルを追加するだけで済む。

-   **`src/core/visualize.py`**:
    -   **責務**: 検索結果のDataFrameを元に、分析グラフ（出願人ランキング等）を生成する。
    -   **設計意図**: グラフ描画ロジックをUIから分離する。`plotly`ライブラリに依存し、`Figure`オブジェクトを返す。UI側は受け取ったオブジェクトを`st.plotly_chart`で表示するだけでよい。

-   **`src/core/reporter.py`**:
    -   **責務**: ユーザーが選択した特許データと調査方針を元に、LLM（OpenAI API）を用いてサマリーレポートを生成する。
    -   **設計意図**: レポート生成というビジネスロジックをUIから分離する。プロンプトテンプレートを内包し、整形されたMarkdown文字列を返す。

-   **`tests/`**:
    -   **責務**: UIから完全に独立して、コアロジックの動作を検証するためのテストスクリプトを格納する。
    -   **設計意図**: プロジェクトの品質保証の要。UI経由では特定が困難なエラー（例: SQL構文エラー）を迅速に発見・修正するためのセーフティネットとして機能する。`pytest`フレームワークとの連携を想定している。

## 4. 開発ロードマップ

### 完了済みタスク
-   **基盤設計とUIモックアップ**
-   **対話型検索フローの実装**
-   **検索実行とロジック安定化**
-   **結果の可視化機能の実装**
-   **AIによる要約レポート生成**

### 今後の開発タスク
-   **Task 1: 検索履歴の蓄積・再利用機能**
    -   **目的**: 過去の調査を記録し、再現性を高める。
    -   **実装案**: 検索条件と結果の概要を軽量DB（SQLiteなど）に保存し、サイドバーから呼び出せるようにする。
-   **Task 2: `pytest`の導入とテストの自動化**
    -   **目的**: 手動テストから脱却し、CIへの道を開く。
    -   **実装案**: `tests/`内のスクリプトを`pytest`形式にリファクタリングし、正常系・異常系のテストケースを拡充する。
