# AI特許調査プログラム 開発中断サマリー

## 概要版（初心者向け解説）

### 1. 開発中の機能名・目的
- **機能名:** AI対話型 特許調査アシスタント
- **目的:** 専門家でなくても、AIと会話するだけで、まるでプロが調査したかのような精度の高い特許検索ができるようにすること。

### 2. これまでに実装・検討済みの内容の要約
- AI(OpenAI)と会話しながら、調査したい内容に合った「キーワード」や「特許分類」を自動で提案する基本機能を作りました。
- 提案された条件を基に、Googleの巨大な公開特許データベース(BigQuery)を検索するための命令文(SQL)を自動で生成する機能を実装しました。
- 最初はデータベース接続で多くのエラーが出ましたが、お手本コード(`query_test.ipynb`)を分析し、サービスアカウントキーという「特別な鍵」を使うことで解決しました。
- 様々な検索戦略（例えば、「キーワード」と「分類」の両方に当てはまるものを探す厳しい検索や、どちらか一方で良いという広い検索など）を何度もテストし、それぞれの結果がどう変わるかを検証しました。

### 3. 現在のステータス
- **完了:** AIとの対話から、特許データベースを検索し、結果をレポートとして出力するまでの一連の流れ（パイプライン）は完成しています。
- **課題:** 現在の検索方法では、調査の意図に100%合致する「ど真ん中」の特許を見つけ出すには至っていません。精度に改善の余地があります。

### 4. 直前の指示とその応答内容の要約
- **直前の指示:** 「これまでのテスト結果は信じられない。何かが間違っている。お手本をベースに、もっと網羅的な検索（キーワード拡張、IPC緩和）を試してほしい」というご指示でした。
- **応答:** ご指示通り、網羅性を高める3パターンのテストを実行しましたが、それでもなお調査の核心を突く結果は得られませんでした。

### 5. 未解決の課題、懸念点、次回以降のTODOリスト
- **未解決の課題:** 現在の検索アプローチでは、的を絞ろうとするとヒットせず、範囲を広げるとノイズが多くなる、というジレンマに陥っています。
- **次回以降のTODO:**
  1.  これまでのテストで見つかった「惜しい」特許（近傍特許）をリストアップする。
  2.  それらをAIに分析させ、「本当に探している特許は、どのような専門用語や特許分類で表現されている可能性があるか？」を逆に推論させる（メタ分析）。
  3.  AIが提案した新しい検索条件で、再度テストを実行する。

### 6. 依存関係のあるファイルや関数一覧
- `patent_search_script.py`: AIと対話しながら検索を実行するメインのプログラムです。
- `corded-guild-459506-i6-5bc162f91e16.json`: Googleのデータベースに接続するための「鍵」ファイルです。

### 7. 次回作業再開時に最初に実行すべきステップの提案
- 次回は、上記TODOリストにある**「メタ分析」アプローチ**を試すことから始めるのが最も効果的です。具体的には、私（AIアシスタント）に「近傍特許を分析して、新しい検索戦略を提案して」と指示してください。

---
---

## 詳細版（Gemini CLI向け指示）

### 1. 開発中の機能名・目的
- **機能名:** AI対話型特許検索プログラム
- **目的:** 自然言語による対話を通じて、ユーザーの調査意図を反映したBigQueryのSQLクエリを動的に生成し、`patents-public-data`を検索。検索結果をLLMで評価し、レポートを自動生成する。

### 2. これまでに実装・検討済みの内容の要約
- **LLM移行:** Gemini APIからOpenAI API (`gpt-4-turbo`) へ移行完了。
- **BigQuery接続確立:** 当初`403 Permission Denied`エラーが頻発したが、`query_test.ipynb`の分析により、`os.environ["GOOGLE_APPLICATION_CREDENTIALS"]`でサービスアカウントキーを明示的に指定する方法で解決。
- **SQL生成ロジック:** パラメータ化クエリ (`ScalarQueryParameter`) と、スカラサブクエリ `(SELECT text FROM UNNEST(...) LIMIT 1)` を用いた、実績のあるSQL生成ロジックを確立。
- **検索戦略の体系的テスト:** 以下の検索ロジックを実装・テスト済み。
  - `(IPC OR) AND (Keyword Group AND)`: ヒット0件
  - `(IPC AND) AND (Keyword OR)`: ヒット2件（v3）
  - `(IPC OR) OR (Keyword OR)`: ヒット50件（v4）
  - `(Subject IPC OR) AND (Predicate IPC OR Keyword OR)`: ヒット50件（v5）
  - `(Expanded Keyword OR) OR (Base IPC OR)`: ヒット50件
  - `(Base Keyword OR) OR (Relaxed IPC OR)`: ヒット50件
  - `(Expanded Keyword OR) OR (Relaxed IPC OR)`: ヒット50件

### 3. 現在のステータス
- **完了:** 対話型検索パイプラインの基本実装。レポート自動生成機能。
- **課題:** 生成される検索式の精度。現在のロジックでは、調査意図に完全に合致する特許の抽出に至っていない。

### 4. 直前の指示とその応答内容の要約
- **直前の指示:** 検索戦略の「緩和」の意図を再指示。「キーワード拡張」と「IPC階層緩和」を、網羅的な `OR` ロジックをベースに実行するよう要求された。
- **応答:** 指示通り3パターンの緩和テストを実行し、レポートを生成した。しかし、ヒット件数は多いものの、LLM評価では精度が低いことが示唆された。

### 5. 未解決の課題、懸念点、次回以降のTODOリスト
- **未解決の課題:** 最適な検索論理（SQLのWHERE句構造）と、検索ターム（キーワード、IPC）の組み合わせが未特定。
- **懸念点:** 現在のキーワードとIPCの選定自体が、調査対象技術の実際の表現と乖離している可能性がある。
- **次回TODO:**
  1.  `v5_refined`テスト等で得られた近傍特許（例: `US-9360848-B2`, `US-10597308-B2`）の要約を収集する。
  2.  収集した情報をインプットとして、OpenAI APIに対し、**(a) 新しいキーワード候補、(b) 新しいIPC分類候補、(c) 新しい検索戦略（WHERE句の論理構造）**を提案させる「メタ分析」プロンプトを実行する。
  3.  得られた提案に基づき、`final_report_runner_v6_meta.py`のような新しいテストスクリプトを生成・実行し、有効性を検証する。

### 6. 依存関係のあるファイルや関数一覧
- **Files:** `patent_search_script.py`, `corded-guild-459506-i6-5bc162f91e16.json`
- **Libraries:** `openai`, `google-cloud-bigquery`
- **Key Functions:** `execute_bigquery_search()`

### 7. 次回作業再開時に最初に実行すべきステップの提案
- **コマンド:** `read_file`
- **パス:** `investigations\inv_20250722_005103\summary_report_v5_refined.txt` (または関連性の高かった他のレポート)
- **指示:** 「このレポートで得られた近傍特許を基に、新しい検索戦略を提案してください。具体的には、新しいキーワード、IPC分類、そしてSQLのWHERE句の論理構造を提案してほしい。」という趣旨の指示から開始する。


 1. 2つの戦略の比較と分析

  まず、比較対象となる2つのレポートが代表する戦略を振り返ります。

   * レポートB (Keywords Relaxed / IPC AND)
       * 戦略: (IPC_A AND IPC_B AND IPC_C) AND (Keyword_1 OR Keyword_2 ...)
       * 結果: 2件ヒット。しかし、テーマとの関連性は中程度。
       * 分析: 3つの異なるIPC分類すべてを持つことを要求したため、条件が厳しすぎました。これにより、本来見るべきだったかもしれない特許が排除されてしまいました。

   * レポートB (IPC Relaxation / `OR` Logic)
       * 戦略: (緩和IPC_A OR 緩和IPC_B OR ...) OR (Keyword_1 OR Keyword_2 ...)
       * 結果: 50件ヒット。しかし、ノイズが多い。
       * 分析: IPCとキーワードをすべて OR でつないだため、例えば G05B (一般的な制御システム) の分類を持つだけで、膜とは全く関係のない特許まで大量にヒットしてしまいました。

  2. ご指摘の核心：「技術の主語」の固定

  ご指摘の「技術の主語になるものは階層的分類は具体化するのが良い」という点は、まさに専門的な特許調査の要諦です。

  今回の調査テーマ「逆浸透膜における機械学習を用いた運転最適化」において、

   * 技術の主語（何についての技術か？）:
       * 逆浸透膜 (B01D61/02, C02F1/44)
   * 技術の述語（それをどうする技術か？）:
       * 機械学習を用いた運転最適化 (G05B13/02)

  と定義できます。

  ご指摘の通り、調査の軸となる「主語」は安易に緩和すべきではありません。主語を緩和すると、調査対象そのものがぼやけてしまい、大量のノイズが発生します。前回のテストC（両方緩
  和）がまさにその例です。

  一方で、「述語」、つまり「どうする技術か」の部分は、様々な表現や分類が考えられるため、緩和の対象として適切です。

  3. 導き出される、より高度な検索戦略

  これらの分析とご指摘を統合すると、以下のような、はるかに洗練された検索戦略が導き出されます。

  「技術の主語（逆浸透膜）は必須条件とし、その上で、緩和した述語（制御システム全般）に合致するか、または、いずれかのキーワードに合致する特許を探す」

  これをSQLのロジックに落とし込むと、以下のようになります。

    1 WHERE
    2   -- 1. 【主語は必須】特許分類が「逆浸透膜」または「膜水処理」であること
    3   (
    4     EXISTS (... ipc.code LIKE 'B01D61/02%')
    5     OR
    6     EXISTS (... ipc.code LIKE 'C02F1/44%')
    7   )
    8
    9 AND -- かつ
   10
   11   -- 2. 【述語は緩和 or キーワード】特許分類が「一般的な制御システム」であるか、または、いずれかのキーワードに合致すること
   12   (
   13     EXISTS (... ipc.code LIKE 'G05B%') -- ← 緩和したIPC
   14     OR
   15     LOWER(...) LIKE '%機械学習%' OR LOWER(...) LIKE '%AI%' OR ... -- ← 全キーワード
   16   )

  この戦略であれば、軸足を「逆浸透膜」にしっかりと置いたまま、関連する制御技術や新しい表現の技術を幅広く捉えることができ、これまでのテストで最もバランスの取れた、質の高い
  結果が期待できます。


    根本原因の分析と新しい戦略の提案

  これまでの失敗の根本原因は、私たちが定義したキーワードやIPC分類が、調査対象の技術が実際に特許公報で使われている言葉や分類と、まだ乖離がある可能性が高い、という点にありま
  す。

  そこで、これ以上やみくもに検索を繰り返すのではなく、一度立ち止まり、より分析的なアプローチに切り替えることを提案します。

  提案：LLMを用いた「検索結果のメタ分析」による、次の戦略立案

  これは、私たちがこれまでに見つけた「惜しい」特許（近傍特許）をAIに分析させ、「なぜこれらは完全な正解ではなかったのか？」「では、本当に正解の特許は、どのような言葉や分類
  で書かれている可能性があるのか？」を推論させる、というアプローチです。

  具体的な実行計画:

   1. 情報収集: 最後のテスト(v5_refined)で得られた、最も関連性が高そうだった特許数件の要約を収集します。
   2. LLMへの質問: OpenAI APIに対し、以下のような、より高度な質問を投げかけます。

    1     # 指示
    2     あなたは、特許調査戦略を立案するトップレベルのコンサルタントです。
    3
    4     # 私の最終目的
    5     「逆浸透膜における機械学習を用いた運転最適化」に関する特許を見つけ出すこと。
    6
    7     # これまでの経緯
    8
      様々な検索を試したが、3つの要素（逆浸透膜、機械学習、最適化）を完全に満たす特許は見つかっていない。以下に、これまでに見つかった中で、最も関連性が高そうだっ
      たが、完全ではなかった特許の要約を提示する。
    9
   10     # 【近傍特許の要約リスト】
   11     - US-9360848-B2: Reverse-osmosis water desalination plant... (要約)
   12     - US-10597308-B2: Water treatment plant controlling method... (要約)
   13     - ...
   14
   15     # あなたへの質問
   16     1.  これらの「惜しい」特許の分析に基づき、私の最終目的に合致する特許が、どのような**別のキーワード**
      （より専門的な同義語、具体的なアルゴリズム名、業界用語など）で表現されている可能性があるか、5つ提案してください。
   17     2.  同様に、どのような**別のIPC分類**（よりニッチな下位分類や、これまで見落としていた分類など）が付与されている可能性があるか、3つ提案してください。
   18     3.  これらの新しいキーワードとIPC分類を使い、どのような**新しい検索戦略（SQLのWHERE句のロジック）**
      を試すべきか、最も有効だと思われるものを1つ提案してください。
   3. 新戦略の提示: LLMから得られた新しいキーワード、IPC分類、そして検索戦略を、次の具体的なアクションプランとしてあなたに提示します。

  この「メタ分析」アプローチにより、私たちはこれまでの失敗から学び、より成功の確率が高い、洗練された次の調査に進むことができます。

  この新しい、より分析的なアプローチで調査を次の段階に進めてよろしいでしょうか？
